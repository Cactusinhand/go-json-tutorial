# 从零开始的 JSON 库教程（九）：错误处理增强

## 高级教程开始

从本章开始，我们将进入 JSON 库的高级教程部分，着重于提升库的实用性、性能和安全性。在基础教程（教程一至八）中，我们已经实现了一个功能完整的 JSON 库，包括解析、生成和各种操作功能。现在，我们将进一步完善这个库，使其更加健壮和实用。

## 教程九：增强错误处理

在本教程中，我们将为JSON解析库添加增强的错误处理功能，提供更丰富的错误信息和更强大的恢复机制。这些功能对于构建健壮的应用程序至关重要，尤其是在处理用户输入或外部数据源时。

## 主要内容

1. **详细的错误信息**：
   - 不仅显示错误类型，还提供行号和列号
   - 显示错误上下文（出错位置附近的代码）
   - 提供指向错误位置的指针，直观展示错误位置

2. **错误恢复机制**：
   - 允许从某些错误中恢复并继续解析
   - 可配置的错误恢复策略
   - 在遇到非致命错误时用null替代错误值

3. **解析选项**：
   - 支持JSON注释（单行//和多行/* */）
   - 可配置的嵌套深度限制
   - 错误恢复开关

4. **改进的错误处理接口**：
   - 使用结构化的错误信息
   - 更好的位置跟踪
   - 支持国际化错误消息

## 实现要点

### 1. 增强的错误信息

我们实现了`EnhancedError`结构体，它包含以下信息：

- 错误代码：指示错误的类型
- 错误消息：人类可读的错误描述
- 行号和列号：错误发生的位置
- 上下文：错误发生附近的代码片段
- 指针：指向错误位置的可视化指示器
- 源码输入：原始JSON输入
- 是否可恢复：指示该错误是否可以从中恢复

### 2. 解析上下文改进

- 跟踪行号和列号
- 记录每行的起始位置以便定位错误
- 支持嵌套深度限制和检查
- 增加了对注释解析的支持

### 3. 错误恢复策略

允许从某些非致命错误中恢复：

- 数组中的无效值
- 对象中的无效值
- 格式错误的字符串
- 其他可恢复的语法错误

## 使用示例

基本解析（与之前版本兼容）：

```go
var v Value
err := Parse(&v, jsonText)
if err != PARSE_OK {
    // 处理错误
}
```

使用增强选项：

```go
var v Value
options := ParseOptions{
    RecoverFromErrors: true,  // 启用错误恢复
    AllowComments: true,      // 允许注释
    MaxDepth: 100             // 设置最大嵌套深度
}
err := ParseWithOptions(&v, jsonText, options)
```

## 性能考虑

虽然增强的错误处理提供了更多功能，但也带来了一些性能开销：

- 跟踪位置信息需要额外的计算
- 错误恢复需要额外的状态管理
- 注释解析增加了额外的代码路径

在性能关键的应用中，可以通过配置选项来禁用某些高开销的功能。

## 结论

本教程通过增强错误处理系统，大大提高了JSON解析库的用户友好性和健壮性。这些改进使库更适合在生产环境中使用，特别是在处理不可信数据时。通过提供详细的错误信息和恢复机制，可以帮助开发者更快地定位和解决问题。