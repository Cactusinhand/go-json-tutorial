# 从零开始的 JSON 库教程（三）：解析字符串 (Go语言版)

## 1. JSON 字符串语法

JSON 的字符串语法和 Go 语言很相似，都是以双引号把字符括起来，如 `"Hello"`。但字符串采用了双引号作分隔，那么怎样可以在字符串中插入一个双引号？ 把 `a"b` 写成 `"a"b"` 肯定不行，都不知道那里是字符串的结束了。因此，我们需要引入转义字符（escape character），Go 语言和 JSON 都使用 `\`（反斜线）作为转义字符，那么 `"` 在字符串中就表示为 `\"`，`a"b` 的 JSON 字符串则写成 `"a\"b"`。如以下的字符串语法所示，JSON 共支持 9 种转义序列：

```
string = quotation-mark *char quotation-mark
char = unescaped /
   escape (
       %x22 /          ; "    quotation mark  U+0022
       %x5C /          ; \    reverse solidus U+005C
       %x2F /          ; /    solidus         U+002F
       %x62 /          ; b    backspace       U+0008
       %x66 /          ; f    form feed       U+000C
       %x6E /          ; n    line feed       U+000A
       %x72 /          ; r    carriage return U+000D
       %x74 /          ; t    tab             U+0009
       %x75 4HEXDIG )  ; uXXXX                U+XXXX
escape = %x5C          ; \
quotation-mark = %x22  ; "
unescaped = %x20-21 / %x23-5B / %x5D-10FFFF
```

简单翻译一下，JSON 字符串是由前后两个双引号夹着零至多个字符。字符分为无转义字符或转义序列。转义序列有 9 种，都是以反斜线开始，如常见的 `\n` 代表换行符。比较特殊的是 `\uXXXX`，当中 XXXX 为 16 进位的 UTF-16 编码，本单元将不处理这种转义序列，留待下回分解。

无转义字符就是普通的字符，语法中列出了合法的码点范围（码点还是在下单元才介绍）。要注意的是，该范围不包括 0 至 31、双引号和反斜线，这些码点都必须要使用转义方式表示。

## 2. 字符串表示

在 Go 语言中，字符串是一种基本类型，表示为不可变的字节序列。Go 字符串可以包含任何字节，包括空字节（`'\0'`）。这与 C 语言中的空结尾字符串（null-terminated string）不同，C 语言中以空字符代表字符串的结束。

例如，JSON 字符串 `"Hello\u0000World"` 在解析后是一个包含 11 个字符的字符串，其中包含一个空字符。在 Go 中，我们可以直接使用内置的 string 类型来表示这样的字符串，而不需要像 C 语言那样特殊处理空字符。

在我们的 JSON 库中，我们将使用 Go 的 string 类型来存储解析后的字符串值。

## 3. 内存管理

与 C 语言不同，Go 语言有自动内存管理（垃圾回收），我们不需要手动分配和释放内存。当我们创建一个字符串时，Go 运行时会自动处理内存分配，当字符串不再被引用时，垃圾回收器会自动回收内存。

在我们的 JSON 库中，当设置一个值为字符串时，我们只需要简单地将字符串赋值给 Value 结构体中的相应字段：

```go
func (v *Value) SetString(s string) {
    v.Type = STRING
    v.S = s
}
```

## 4. 解析字符串

解析 JSON 字符串需要处理转义序列。我们需要检查字符串是否以双引号开始和结束，然后解析字符串内容，处理各种转义序列。

在本章中，我们将实现字符串的解析功能，包括处理各种转义序列，如 `\"`、`\\`、`\/`、`\b`、`\f`、`\n`、`\r`、`\t`。我们暂时不处理 Unicode 转义序列 `\uXXXX`，这将在下一章中实现。

## 5. 总结

本章我们将实现 JSON 字符串的解析，包括：

1. 修改 Value 结构体，添加字符串类型的支持
2. 实现字符串的解析函数
3. 处理各种转义序列
4. 添加相应的单元测试

通过本章的学习，我们的 JSON 库将能够解析 JSON 字符串，为后续解析更复杂的 JSON 数据类型（如数组和对象）打下基础。