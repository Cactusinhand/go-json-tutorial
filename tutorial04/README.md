# ä»é›¶å¼€å§‹çš„ JSON åº“æ•™ç¨‹ï¼ˆå››ï¼‰ï¼šè§£æå­—ç¬¦ä¸² (Goè¯­è¨€ç‰ˆ)


æœ¬æ–‡æ˜¯ã€Šä»é›¶å¼€å§‹çš„ JSON åº“æ•™ç¨‹ã€‹çš„ç¬¬å››ä¸ªå•å…ƒã€‚æœ¬å•å…ƒçš„æºä»£ç ä½äº [json-tutorial/go-json-tutorial/tutorial04](https://github.com/miloyip/json-tutorial/blob/master/go-json-tutorial/tutorial04/)ã€‚

æœ¬å•å…ƒå†…å®¹ï¼š

1. [JSON å­—ç¬¦ä¸²è¯­æ³•](#1-json-å­—ç¬¦ä¸²è¯­æ³•)
2. [å­—ç¬¦ä¸²è¡¨ç¤º](#2-å­—ç¬¦ä¸²è¡¨ç¤º)
3. [å†…å­˜ç®¡ç†](#3-å†…å­˜ç®¡ç†)
4. [è§£æå­—ç¬¦ä¸²](#4-è§£æå­—ç¬¦ä¸²)
5. [æ€»ç»“ä¸ç»ƒä¹ ](#5-æ€»ç»“ä¸ç»ƒä¹ )
6. [å‚è€ƒ](#6-å‚è€ƒ)

## 1. JSON å­—ç¬¦ä¸²è¯­æ³•

JSON å­—ç¬¦ä¸²è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œä½†æœ‰å‡ ä¸ªè½¬ä¹‰ç¬¦ï¼ˆescapeï¼‰è¦å¤„ç†ã€‚å®Œæ•´çš„è¯­æ³•å¦‚ä¸‹ï¼š

```
string = quotation-mark *char quotation-mark
char = unescaped /
   escape (
       %x22 /          ; "    quotation mark  U+0022
       %x5C /          ; \    reverse solidus U+005C
       %x2F /          ; /    solidus         U+002F
       %x62 /          ; b    backspace       U+0008
       %x66 /          ; f    form feed       U+000C
       %x6E /          ; n    line feed       U+000A
       %x72 /          ; r    carriage return U+000D
       %x74 /          ; t    tab             U+0009
       %x75 4HEXDIG )  ; uXXXX                U+XXXX
escape = %x5C          ; \
quotation-mark = %x22  ; "
unescaped = %x20-21 / %x23-5B / %x5D-10FFFF
```

ç®€å•æ¥è¯´ï¼ŒJSON å­—ç¬¦ä¸²æ˜¯ç”±åŒå¼•å·åŒ…å›´çš„ä»»æ„æ•°é‡å­—ç¬¦ã€‚å­—ç¬¦åˆ†ä¸ºæ— è½¬ä¹‰å­—ç¬¦æˆ–è½¬ä¹‰åºåˆ—ã€‚è½¬ä¹‰åºåˆ—ä»¥åæ–œçº¿å¼€å§‹ï¼Œç´§æ¥ç€æ˜¯ä»¥ä¸‹å­—ç¬¦ï¼š

* `"`: åŒå¼•å·
* `\`: åæ–œçº¿
* `/`: æ­£æ–œçº¿
* `b`: é€€æ ¼ç¬¦
* `f`: æ¢é¡µç¬¦
* `n`: æ¢è¡Œç¬¦
* `r`: å›è½¦ç¬¦
* `t`: åˆ¶è¡¨ç¬¦
* `uXXXX`: 4 ä½åå…­è¿›åˆ¶æ•°å­—è¡¨ç¤ºçš„ Unicode ç ç‚¹

æ— è½¬ä¹‰å­—ç¬¦æ˜¯é™¤äº†åŒå¼•å·ã€åæ–œçº¿å’Œæ§åˆ¶å­—ç¬¦ï¼ˆU+0000 è‡³ U+001Fï¼‰ä»¥å¤–çš„æ‰€æœ‰å­—ç¬¦ã€‚

## 2. å­—ç¬¦ä¸²è¡¨ç¤º

åœ¨ Go è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å†…ç½®çš„ `string` ç±»å‹æ¥è¡¨ç¤º JSON å­—ç¬¦ä¸²ã€‚è¿™æ˜¯å› ä¸º Go çš„å­—ç¬¦ä¸²æœ¬èº«å°±æ˜¯ UTF-8 ç¼–ç çš„ï¼Œå¯ä»¥å¾ˆå¥½åœ°è¡¨ç¤º Unicode å­—ç¬¦ã€‚

æˆ‘ä»¬åœ¨ `Value` ç»“æ„ä½“ä¸­æ·»åŠ äº†ä¸€ä¸ª `S` å­—æ®µæ¥å­˜å‚¨å­—ç¬¦ä¸²å€¼ï¼š

```go
// Value è¡¨ç¤ºä¸€ä¸ªJSONå€¼
type Value struct {
    Type   ValueType `json:"type"`   // å€¼ç±»å‹
    N      float64   `json:"n"`      // æ•°å­—å€¼ï¼ˆå½“Typeä¸ºNUMBERæ—¶æœ‰æ•ˆï¼‰
    S      string    `json:"s"`      // å­—ç¬¦ä¸²å€¼ï¼ˆå½“Typeä¸ºSTRINGæ—¶æœ‰æ•ˆï¼‰
}
```

åŒæ—¶ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª `GetString` å‡½æ•°æ¥è·å–å­—ç¬¦ä¸²å€¼ï¼š

```go
// GetString è·å–JSONå­—ç¬¦ä¸²å€¼
func GetString(v *Value) string {
    return v.S
}
```

## 3. å†…å­˜ç®¡ç†

Go è¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„ï¼Œå½“æˆ‘ä»¬éœ€è¦æ„å»ºå­—ç¬¦ä¸²æ—¶ï¼Œé€šå¸¸ä½¿ç”¨ `[]byte` åˆ‡ç‰‡æ¥ç´¯ç§¯å­—ç¬¦ï¼Œç„¶ååœ¨æœ€åè½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚è¿™ç§æ–¹å¼æ—¢é«˜æ•ˆåˆå®‰å…¨ï¼Œå› ä¸ºï¼š

1. åˆ‡ç‰‡å¯ä»¥åŠ¨æ€å¢é•¿ï¼Œé¿å…äº†é¢‘ç¹çš„å†…å­˜åˆ†é…
2. Go çš„åƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œæ— éœ€æ‰‹åŠ¨é‡Šæ”¾

åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œä½¿ç”¨äº† `[]byte` åˆ‡ç‰‡æ¥æ„å»ºå­—ç¬¦ä¸²ï¼š

```go
var sb []byte
// ... æ·»åŠ å­—ç¬¦åˆ° sb ...
*s = string(sb)
```

## 4. è§£æå­—ç¬¦ä¸²

è§£æ JSON å­—ç¬¦ä¸²çš„ä¸»è¦æŒ‘æˆ˜åœ¨äºå¤„ç†å„ç§è½¬ä¹‰åºåˆ—ï¼Œç‰¹åˆ«æ˜¯ Unicode è½¬ä¹‰åºåˆ—ã€‚æˆ‘ä»¬çš„å®ç°åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. è·³è¿‡å¼€å¤´çš„åŒå¼•å·
2. é€å­—ç¬¦è§£æï¼Œç›´åˆ°é‡åˆ°ç»“æŸçš„åŒå¼•å·
3. å¤„ç†è½¬ä¹‰åºåˆ—
4. ç‰¹åˆ«å¤„ç† Unicode è½¬ä¹‰åºåˆ—ï¼ŒåŒ…æ‹¬ä»£ç†å¯¹ï¼ˆsurrogate pairsï¼‰

ä»¥ä¸‹æ˜¯è§£æå­—ç¬¦ä¸²çš„æ ¸å¿ƒä»£ç ï¼š

```go
// parseString è§£æå­—ç¬¦ä¸²å€¼
func parseString(c *context, v *Value) ParseError {
    return parseStringRaw(c, &v.S, v)
}

// parseStringRaw è§£æå­—ç¬¦ä¸²ï¼Œå¯é€‰æ‹©æ˜¯å¦è®¾ç½®å€¼
func parseStringRaw(c *context, s *string, v *Value) ParseError {
    var sb []byte
    c.index++ // è·³è¿‡å¼€å¤´çš„å¼•å·
    
    for c.index < len(c.json) {
        ch := c.json[c.index]
        if ch == '"' {
            c.index++
            if v != nil {
                v.Type = STRING
            }
            *s = string(sb)
            return PARSE_OK
        } else if ch == '\\' {
            c.index++
            if c.index >= len(c.json) {
                return PARSE_INVALID_STRING_ESCAPE
            }
            
            switch c.json[c.index] {
            case '"', '\\', '/':
                sb = append(sb, c.json[c.index])
            case 'b':
                sb = append(sb, '\b')
            case 'f':
                sb = append(sb, '\f')
            case 'n':
                sb = append(sb, '\n')
            case 'r':
                sb = append(sb, '\r')
            case 't':
                sb = append(sb, '\t')
            case 'u':
                // è§£æ4ä½åå…­è¿›åˆ¶æ•°å­—
                // ... å¤„ç†Unicodeè½¬ä¹‰åºåˆ— ...
            default:
                return PARSE_INVALID_STRING_ESCAPE
            }
        } else if ch < 0x20 {
            // æ§åˆ¶å­—ç¬¦å¿…é¡»è½¬ä¹‰
            return PARSE_INVALID_STRING_CHAR
        } else {
            sb = append(sb, ch)
        }
        c.index++
    }
    
    return PARSE_MISS_QUOTATION_MARK
}
```

### å¤„ç† Unicode è½¬ä¹‰åºåˆ—

Unicode è½¬ä¹‰åºåˆ—çš„å¤„ç†æ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯å½“æ¶‰åŠåˆ°ä»£ç†å¯¹ï¼ˆsurrogate pairsï¼‰æ—¶ã€‚ä»£ç†å¯¹æ˜¯ä¸€ç§åœ¨ UTF-16 ç¼–ç ä¸­è¡¨ç¤ºè¶…å‡ºåŸºæœ¬å¤šè¯­è¨€å¹³é¢ï¼ˆBMPï¼‰å­—ç¬¦çš„æ–¹å¼ã€‚

ä¾‹å¦‚ï¼ŒéŸ³ä¹ç¬¦å· ğ„ çš„ Unicode ç ç‚¹æ˜¯ U+1D11Eï¼Œå®ƒè¶…å‡ºäº† BMP çš„èŒƒå›´ï¼ˆU+0000 è‡³ U+FFFFï¼‰ã€‚åœ¨ UTF-16 ä¸­ï¼Œå®ƒè¢«ç¼–ç ä¸ºä¸¤ä¸ª 16 ä½å€¼ï¼š0xD834 å’Œ 0xDD1Eï¼Œåˆ†åˆ«ç§°ä¸ºé«˜ä»£ç†é¡¹å’Œä½ä»£ç†é¡¹ã€‚åœ¨ JSON ä¸­ï¼Œè¿™ä¸ªå­—ç¬¦å¯ä»¥è¡¨ç¤ºä¸º `"\uD834\uDD1E"`ã€‚

æˆ‘ä»¬çš„å®ç°éœ€è¦æ­£ç¡®å¤„ç†è¿™ç§æƒ…å†µï¼Œå°†ä»£ç†å¯¹è½¬æ¢ä¸ºæ­£ç¡®çš„ Unicode ç ç‚¹ï¼Œç„¶åç¼–ç ä¸º UTF-8ï¼š

```go
// å¤„ç†UTF-16ä»£ç†å¯¹
if codepoint >= 0xD800 && codepoint <= 0xDBFF {
    // é«˜ä»£ç†é¡¹ï¼Œéœ€è¦åé¢è·Ÿç€ä½ä»£ç†é¡¹
    if c.index+6 >= len(c.json) || 
        c.json[c.index+1] != '\\' || 
        c.json[c.index+2] != 'u' {
        return PARSE_INVALID_UNICODE_SURROGATE
    }
    
    c.index += 2 // è·³è¿‡ \u
    var codepoint2 int
    // ... è§£æä½ä»£ç†é¡¹ ...
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä½ä»£ç†é¡¹
    if codepoint2 < 0xDC00 || codepoint2 > 0xDFFF {
        return PARSE_INVALID_UNICODE_SURROGATE
    }
    
    // è®¡ç®—Unicodeç ç‚¹
    codepoint = 0x10000 + ((codepoint - 0xD800) << 10) + (codepoint2 - 0xDC00)
}

// å°†Unicodeç ç‚¹ç¼–ç ä¸ºUTF-8
buf := make([]byte, 4)
n := utf8.EncodeRune(buf, rune(codepoint))
sb = append(sb, buf[:n]...)
```

## 5. æ€»ç»“ä¸ç»ƒä¹ 

æœ¬å•å…ƒæˆ‘ä»¬å®ç°äº† JSON å­—ç¬¦ä¸²çš„è§£æï¼ŒåŒ…æ‹¬å¤„ç†å„ç§è½¬ä¹‰åºåˆ—å’Œ Unicode å­—ç¬¦ã€‚Go è¯­è¨€çš„å†…ç½®å­—ç¬¦ä¸²ç±»å‹å’Œ UTF-8 æ”¯æŒä½¿å¾—å®ç°ç›¸å¯¹ç®€å•ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦å°å¿ƒå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µã€‚

ç»ƒä¹ ï¼š

1. ä¿®æ”¹ `parseStringRaw` å‡½æ•°ï¼Œä½¿ç”¨ `strings.Builder` ä»£æ›¿ `[]byte` åˆ‡ç‰‡æ¥æ„å»ºå­—ç¬¦ä¸²ï¼Œæ¯”è¾ƒä¸¤ç§å®ç°çš„æ€§èƒ½å·®å¼‚ã€‚
2. å®ç°ä¸€ä¸ª `SetString` å‡½æ•°ï¼Œå…è®¸è®¾ç½® `Value` çš„å­—ç¬¦ä¸²å€¼ã€‚
3. æ‰©å±•æµ‹è¯•ç”¨ä¾‹ï¼Œæµ‹è¯•æ›´å¤šçš„ Unicode å­—ç¬¦å’Œè¾¹ç•Œæƒ…å†µã€‚
4. å®ç°å­—ç¬¦ä¸²çš„ç”ŸæˆåŠŸèƒ½ï¼Œå°† `Value` ä¸­çš„å­—ç¬¦ä¸²å€¼è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬é€‚å½“çš„è½¬ä¹‰å¤„ç†ã€‚
5. ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œè€ƒè™‘ä½¿ç”¨é¢„åˆ†é…çš„ç¼“å†²åŒºæ¥å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ã€‚

## 6. å‚è€ƒ

1. [RFC 7159 - The JavaScript Object Notation (JSON) Data Interchange Format](https://tools.ietf.org/html/rfc7159)
2. [The Unicode Standard](https://www.unicode.org/standard/standard.html)
3. [UTF-8, a transformation format of ISO 10646](https://tools.ietf.org/html/rfc3629)
4. [UTF-16, an encoding of ISO 10646](https://tools.ietf.org/html/rfc2781)
5. [Go æ ‡å‡†åº“ - unicode/utf8 åŒ…](https://golang.org/pkg/unicode/utf8/)
6. [Go æ ‡å‡†åº“ - strings åŒ…](https://golang.org/pkg/strings/)

## 7. è¿è¡Œæµ‹è¯•

### å•å…ƒæµ‹è¯•

åœ¨Goè¯­è¨€ä¸­ï¼Œæµ‹è¯•æ˜¯é€šè¿‡å†…ç½®çš„`go test`å‘½ä»¤æ¥è¿è¡Œçš„ã€‚è¦è¿è¡Œæˆ‘ä»¬çš„JSONåº“æµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# åœ¨tutorial04ç›®å½•ä¸‹è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
go test -v

# è¿è¡Œç‰¹å®šçš„æµ‹è¯•å‡½æ•°
go test -run TestParseString
```

### åŸºå‡†æµ‹è¯•

åŸºå‡†æµ‹è¯•ç”¨äºæµ‹é‡ä»£ç çš„æ€§èƒ½ã€‚è¦è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
go test -bench=.

# è¿è¡Œç‰¹å®šçš„åŸºå‡†æµ‹è¯•
go test -bench=BenchmarkParseString

# è¿è¡ŒåŸºå‡†æµ‹è¯•å¹¶æ˜¾ç¤ºå†…å­˜åˆ†é…ä¿¡æ¯
go test -bench=. -benchmem
```

åŸºå‡†æµ‹è¯•çš„è¾“å‡ºç¤ºä¾‹ï¼š

```
BenchmarkParseNull-8           10000000               118 ns/op              0 B/op          0 allocs/op
BenchmarkParseTrue-8           10000000               119 ns/op              0 B/op          0 allocs/op
BenchmarkParseFalse-8          10000000               120 ns/op              0 B/op          0 allocs/op
BenchmarkParseNumber-8          3000000               435 ns/op              0 B/op          0 allocs/op
BenchmarkParseString-8          2000000               756 ns/op             32 B/op          1 allocs/op
BenchmarkParseUnicodeString-8   1000000              1254 ns/op             48 B/op          2 allocs/op
```

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼š

1. è§£æå­—ç¬¦ä¸²æ¯”è§£æåŸºæœ¬ç±»å‹ï¼ˆnullã€trueã€falseï¼‰å’Œæ•°å­—è¦æ…¢ï¼Œè¿™æ˜¯å› ä¸ºå­—ç¬¦ä¸²è§£ææ¶‰åŠæ›´å¤æ‚çš„å¤„ç†é€»è¾‘å’Œå†…å­˜åˆ†é…ã€‚
2. è§£æåŒ…å«Unicodeè½¬ä¹‰åºåˆ—çš„å­—ç¬¦ä¸²æ›´æ…¢ï¼Œéœ€è¦é¢å¤–çš„å¤„ç†æ­¥éª¤ã€‚
3. å­—ç¬¦ä¸²è§£æä¼šå¯¼è‡´å†…å­˜åˆ†é…ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ä¸ºå­—ç¬¦ä¸²å†…å®¹åˆ†é…å†…å­˜ã€‚

## 8. å¸¸è§é—®é¢˜

1. **ä¸ºä»€ä¹ˆä½¿ç”¨`[]byte`è€Œä¸æ˜¯`strings.Builder`æ¥æ„å»ºå­—ç¬¦ä¸²ï¼Ÿ**

   åœ¨Go 1.10ä¹‹å‰ï¼Œ`strings.Builder`è¿˜ä¸å­˜åœ¨ï¼Œä½¿ç”¨`[]byte`æ˜¯ä¸€ç§å¸¸è§çš„å­—ç¬¦ä¸²æ„å»ºæ–¹å¼ã€‚åœ¨ç°ä»£Goç‰ˆæœ¬ä¸­ï¼Œ`strings.Builder`é€šå¸¸æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒä¸“é—¨ä¸ºå­—ç¬¦ä¸²æ„å»ºä¼˜åŒ–ï¼Œå¹¶ä¸”APIæ›´å‹å¥½ã€‚

2. **ä¸ºä»€ä¹ˆéœ€è¦ç‰¹åˆ«å¤„ç†Unicodeä»£ç†å¯¹ï¼Ÿ**

   JSONè§„èŒƒåŸºäºJavaScriptï¼Œè€ŒJavaScriptå­—ç¬¦ä¸²ä½¿ç”¨UTF-16ç¼–ç ã€‚åœ¨UTF-16ä¸­ï¼Œè¶…å‡ºåŸºæœ¬å¤šè¯­è¨€å¹³é¢çš„å­—ç¬¦ï¼ˆU+10000è‡³U+10FFFFï¼‰éœ€è¦ä½¿ç”¨ä»£ç†å¯¹è¡¨ç¤ºã€‚ä¸ºäº†å…¼å®¹æ€§ï¼ŒJSONä¹Ÿé‡‡ç”¨äº†è¿™ç§è¡¨ç¤ºæ–¹å¼ã€‚

3. **Goè¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯UTF-8ç¼–ç çš„ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¤„ç†UTF-16ä»£ç†å¯¹ï¼Ÿ**

   è™½ç„¶Goè¯­è¨€å†…éƒ¨ä½¿ç”¨UTF-8ç¼–ç ï¼Œä½†JSONè§„èŒƒè¦æ±‚æ”¯æŒUTF-16ä»£ç†å¯¹ã€‚æˆ‘ä»¬éœ€è¦å°†JSONä¸­çš„UTF-16ä»£ç†å¯¹æ­£ç¡®è½¬æ¢ä¸ºUTF-8ç¼–ç çš„å­—ç¬¦ã€‚

4. **ä¸ºä»€ä¹ˆæ§åˆ¶å­—ç¬¦ï¼ˆU+0000è‡³U+001Fï¼‰å¿…é¡»è½¬ä¹‰ï¼Ÿ**

   æ§åˆ¶å­—ç¬¦åœ¨æ–‡æœ¬ä¸­å¯èƒ½å¯¼è‡´æ˜¾ç¤ºå’Œè§£æé—®é¢˜ï¼ŒJSONè§„èŒƒè¦æ±‚è¿™äº›å­—ç¬¦å¿…é¡»ä½¿ç”¨è½¬ä¹‰åºåˆ—è¡¨ç¤ºï¼Œä»¥ç¡®ä¿JSONæ–‡æœ¬çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§ã€‚
```